rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================= HELPER FUNCTIONS =========================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return request.auth.uid == uid;
    }

    // ========================= USERS COLLECTION =========================
    match /users/{uid} {
      // Any authenticated user can read any user profile (for messaging, search, etc.)
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      allow create: if isAuthenticated() && isUser(uid);
      
      // Users can update their own profile
      allow update: if isAuthenticated() && isUser(uid);
      
      // Users cannot delete their own profile
      allow delete: if false;

      // ========================= VISITS SUBCOLLECTION =========================
      match /visits/{visitId} {
        // Client can read their own visits
        allow read: if isAuthenticated() && isUser(uid);
        
        // Client can create visits
        allow create: if isAuthenticated() && isUser(uid) &&
          request.resource.data.keys().hasAll(['dateTime', 'status']);
        
        // Client can update their visits
        allow update: if isAuthenticated() && isUser(uid);
        
        // Client can delete their visits
        allow delete: if isAuthenticated() && isUser(uid);
      }

      // ========================= PAYMENTS SUBCOLLECTION =========================
      match /payments/{paymentId} {
        // Client can read their payments
        allow read: if isAuthenticated() && isUser(uid);
        
        // Client can create payments
        allow create: if isAuthenticated() && isUser(uid);
        
        // Client can update their payments
        allow update: if isAuthenticated() && isUser(uid);
        
        // Client can delete their payments
        allow delete: if isAuthenticated() && isUser(uid);
      }

      // ========================= CARE PLANS SUBCOLLECTION =========================
      match /carePlans/{carePlanId} {
        // User can read their own care plans
        allow read: if isAuthenticated() && isUser(uid);
        
        // User can create their own care plans
        allow create: if isAuthenticated() && isUser(uid);
        
        // User can update their own care plans
        allow update: if isAuthenticated() && isUser(uid);
        
        // User can delete their own care plans
        allow delete: if isAuthenticated() && isUser(uid);
      }
    }

    // ========================= JOBS COLLECTION =========================
    match /jobs/{jobId} {
      // Anyone authenticated can read jobs
      allow read: if isAuthenticated();
      
      // Authenticated users can create jobs
      allow create: if isAuthenticated();
      
      // Job owner can update
      allow update: if isAuthenticated();
      
      // Job owner can delete
      allow delete: if isAuthenticated();

      // ========================= APPLICATIONS SUBCOLLECTION =========================
      match /applications/{applicationId} {
        // Authenticated users can read applications
        allow read: if isAuthenticated();
        
        // Authenticated users can create applications
        allow create: if isAuthenticated();
        
        // Authenticated users can update applications
        allow update: if isAuthenticated();
        
        // Authenticated users can delete applications
        allow delete: if isAuthenticated();
      }

      // ========================= MESSAGES SUBCOLLECTION =========================
      match /messages/{messageId} {
        // Authenticated users can read messages
        allow read: if isAuthenticated();
        
        // Authenticated users can send messages
        allow create: if isAuthenticated();
        
        // Users can delete their own messages
        allow delete: if isAuthenticated();
      }

      // ========================= BIDS SUBCOLLECTION =========================
      match /bids/{bidId} {
        // Any authenticated user can read bids
        allow read: if isAuthenticated();
        
        // Caregivers can create bids (must match their own ID)
        allow create: if isAuthenticated() && 
          request.resource.data.caregiverId == request.auth.uid &&
          request.resource.data.keys().hasAll(['jobId', 'caregiverId', 'amount', 'proposal', 'status']) &&
          request.resource.data.status == 'pending';
        
        // Bid owner can update their own bid (amount, proposal, duration only)
        allow update: if isAuthenticated() && 
          (resource.data.caregiverId == request.auth.uid || 
           get(/databases/$(database)/documents/jobs/$(jobId)).data.clientId == request.auth.uid);
        
        // Job owner or bid owner can delete
        allow delete: if isAuthenticated() && 
          (resource.data.caregiverId == request.auth.uid || 
           get(/databases/$(database)/documents/jobs/$(jobId)).data.clientId == request.auth.uid);
      }
    }

    // ========================= CONVERSATIONS COLLECTION =========================
    match /conversations/{conversationId} {
      // Authenticated users can read conversations
      allow read: if isAuthenticated();
      
      // Authenticated users can create conversations
      allow create: if isAuthenticated();
      
      // Authenticated users can update conversations
      allow update: if isAuthenticated();
      
      // Authenticated users can delete conversations
      allow delete: if isAuthenticated();

      // ========================= CONVERSATION MESSAGES SUBCOLLECTION =========================
      match /messages/{messageId} {
        // Authenticated users can read messages
        allow read: if isAuthenticated();
        
        // Authenticated users can send messages
        allow create: if isAuthenticated();
        
        // Users can delete their own messages
        allow delete: if isAuthenticated();
      }
    }

    // ========================= CALLS COLLECTION (WebRTC signaling) =========================
    // Structure:
    // calls/{callId} -> { callerId, conversationId, offer, answer }
    // calls/{callId}/callerCandidates/{cid}
    // calls/{callId}/calleeCandidates/{cid}
    match /calls/{callId} {
      // Only conversation participants may create/read/update/delete call docs
      allow create: if isAuthenticated() &&
        request.resource.data.conversationId is string &&
        // ensure caller is the authenticated user
        request.resource.data.callerId == request.auth.uid &&
        // ensure the caller is a participant in the conversation referenced
        exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)) &&
        get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.participantIds.hasAny([request.auth.uid]);

      allow read: if isAuthenticated() &&
        resource.data.conversationId is string &&
        exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds.hasAny([request.auth.uid]);

      // Allow updates only by participants; restrict which fields can be written
      allow update: if isAuthenticated() &&
        resource.data.conversationId is string &&
        exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds.hasAny([request.auth.uid]) &&
        // Only allow adding an 'answer' or updating small metadata fields
        (request.resource.data.keys().hasOnly(['answer']) || request.resource.data.keys().hasOnly(['answer','updatedAt']));

      allow delete: if isAuthenticated() &&
        resource.data.conversationId is string &&
        exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds.hasAny([request.auth.uid]);

      // callerCandidates subcollection
      match /callerCandidates/{candidateId} {
        allow create: if isAuthenticated() &&
          resource == null &&
          request.resource.data.uid == request.auth.uid &&
          // call exists and caller is a participant
          exists(/databases/$(database)/documents/calls/$(callId)) &&
          (get(/databases/$(database)/documents/calls/$(callId)).data.callerId == request.auth.uid ||
           (exists(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)) &&
           get(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)).data.participantIds.hasAny([request.auth.uid])));

        allow read: if isAuthenticated() &&
          exists(/databases/$(database)/documents/calls/$(callId)) &&
          exists(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)) &&
          get(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)).data.participantIds.hasAny([request.auth.uid]);

        allow delete: if false;
      }

      // calleeCandidates subcollection
      match /calleeCandidates/{candidateId} {
        allow create: if isAuthenticated() &&
          resource == null &&
          request.resource.data.uid == request.auth.uid &&
          exists(/databases/$(database)/documents/calls/$(callId)) &&
          exists(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)) &&
          get(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)).data.participantIds.hasAny([request.auth.uid]);

        allow read: if isAuthenticated() &&
          exists(/databases/$(database)/documents/calls/$(callId)) &&
          exists(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)) &&
          get(/databases/$(database)/documents/conversations/$(get(/databases/$(database)/documents/calls/$(callId)).data.conversationId)).data.participantIds.hasAny([request.auth.uid]);

        allow delete: if false;
      }
    }

    // ========================= TRANSACTIONS (payments) =========================
    // Top-level transactions collection created by clients or server (server uses admin SDK and bypasses rules)
    match /transactions/{txId} {
      // Creator (client) or relevant participant (caregiver) may read
      allow read: if isAuthenticated() && (
        resource.data.clientId == request.auth.uid || resource.data.caregiverId == request.auth.uid);

      // Clients may create transactions where they are the clientId and required fields exist
      allow create: if isAuthenticated() &&
        request.resource.data.clientId == request.auth.uid &&
        request.resource.data.keys().hasAll(['clientId','caregiverId','amount','platformFee','caregiverEarnings','status','reference']);

      // Allow updates to transaction status by authenticated callers only; server (admin SDK) may also update
      allow update: if isAuthenticated() && (
        // allow client or caregiver to update status (e.g., mark refunded) OR admin via admin SDK
        resource.data.clientId == request.auth.uid || resource.data.caregiverId == request.auth.uid);

      allow delete: if false;
    }

    // ========================= CAREGIVER WALLETS =========================
    match /caregiver_wallets/{caregiverId} {
      // Caregiver can read their own wallet
      allow read: if isAuthenticated() && request.auth.uid == caregiverId;

      // Creation and updates are typically done by trusted server code (admin SDK). Allow creation by the caregiver as a convenience, but server processes (admin) bypass rules.
      allow create: if isAuthenticated() && request.auth.uid == caregiverId;
      allow update: if false; // prevent client-side wallet manipulation
      allow delete: if false;
    }

    // ========================= DENY ALL OTHER ACCESS =========================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}